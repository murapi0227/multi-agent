#!/bin/bash
#
# Multi-Agent Framework v2 - セッション開始
#
# 使い方:
#   ma-session [project-dir]
#
# teams モード:
#   tmux session を起動し、Claude Code をリードロール付きで立ち上げる
# tmux モード:
#   既存の setup.sh を呼び出し（後方互換）
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
MA_FRAMEWORK_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

source "$SCRIPT_DIR/lib/common.sh"
source "$SCRIPT_DIR/lib/render.sh"

# 引数からプロジェクトディレクトリを取得
if [[ -n "${1:-}" ]]; then
    cd "$1"
fi

check_project_dir

MODE=$(yaml_value "$CONFIG_FILE" "mode")
MODE="${MODE:-teams}"

PROJECT_NAME=$(yaml_value "$CONFIG_FILE" "project.name")
PROJECT_NAME="${PROJECT_NAME:-$(basename "$PROJECT_ROOT")}"

echo ""
echo "╔══════════════════════════════════════════════╗"
echo "║  Multi-Agent Session: ${PROJECT_NAME}"
echo "╚══════════════════════════════════════════════╝"
echo ""

case "$MODE" in
    teams)
        # リードロールを取得
        LEAD_ROLE=$(yaml_value "$CONFIG_FILE" "lead_role")
        LEAD_ROLE="${LEAD_ROLE:-manager}"

        # リードロールが有効か確認
        if ! is_role_enabled "$LEAD_ROLE" "$CONFIG_FILE"; then
            log_error "リードロール '$LEAD_ROLE' が config.yaml で有効になっていません。"
            log_error "roles.${LEAD_ROLE}.enabled を true にするか、lead_role を変更してください。"
            exit 1
        fi

        # キャラクター名を取得
        case "$LEAD_ROLE" in
            secretary)  CHAR_NAME="草薙素子（少佐）" ;;
            manager)    CHAR_NAME="バトー" ;;
            developer)  CHAR_NAME="タチコマ" ;;
            tester)     CHAR_NAME="タチコマ（慎重型）" ;;
            designer)   CHAR_NAME="タチコマ（美意識型）" ;;
            researcher) CHAR_NAME="タチコマ（分析型）" ;;
            *)          CHAR_NAME="$LEAD_ROLE" ;;
        esac

        log_info "モード: Claude Agent Teams"
        log_info "リードロール: ${LEAD_ROLE} (${CHAR_NAME})"
        echo ""

        # ── Step 1: リードロールのプロンプトをレンダリング ──
        log_info "リードロールのプロンプトを生成中..."

        PROMPT_FILE="$PROJECT_ROOT/.multi-agent/.session-prompt.md"
        if render_lead_prompt "$LEAD_ROLE" "$PROJECT_ROOT" > "$PROMPT_FILE"; then
            log_success "プロンプト生成完了: .multi-agent/.session-prompt.md"
        else
            log_error "プロンプト生成に失敗しました。"
            exit 1
        fi

        # ── Step 2: ランチャースクリプトを生成 ──
        LAUNCHER="$PROJECT_ROOT/.multi-agent/.start-session.sh"
        cat > "$LAUNCHER" <<'LAUNCHER_EOF'
#!/bin/bash
# Auto-generated by ma-session - DO NOT EDIT
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$SCRIPT_DIR/.."
PROMPT=$(cat "$SCRIPT_DIR/.session-prompt.md")
exec claude --append-system-prompt "$PROMPT"
LAUNCHER_EOF
        chmod +x "$LAUNCHER"

        # ── Step 3: tmux session を起動 ──
        SESSION_NAME="${PROJECT_NAME}-ma"

        # 既存セッションのチェック
        if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
            log_warn "tmux session '$SESSION_NAME' が既に存在します。"
            echo ""
            echo "  1) アタッチ（既存セッションに接続）"
            echo "  2) 再起動（既存を終了して新規作成）"
            echo "  3) キャンセル"
            echo ""
            read -p "選択 [1]: " choice
            choice="${choice:-1}"

            case "$choice" in
                1)
                    log_info "既存セッションにアタッチします..."
                    if [[ -n "${TMUX:-}" ]]; then
                        exec tmux switch-client -t "$SESSION_NAME"
                    else
                        exec tmux attach -t "$SESSION_NAME"
                    fi
                    ;;
                2)
                    log_info "既存セッションを終了します..."
                    tmux kill-session -t "$SESSION_NAME"
                    ;;
                *)
                    log_info "キャンセルしました。"
                    exit 0
                    ;;
            esac
        fi

        log_info "tmux session を起動: $SESSION_NAME"
        log_info "ディレクトリ: $PROJECT_ROOT"
        echo ""

        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "  🚀 ${CHAR_NAME} が待機しています"
        echo "  📂 ${PROJECT_ROOT}"
        echo "  💡 tmux detach: Ctrl+B → D"
        echo "  💡 tmux attach: tmux attach -t ${SESSION_NAME}"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo ""

        # tmux session を作成してアタッチ
        if [[ -n "${TMUX:-}" ]]; then
            # 既にtmux内にいる場合: デタッチ状態で作成してからスイッチ
            tmux new-session -d -s "$SESSION_NAME" -c "$PROJECT_ROOT" "$LAUNCHER"
            exec tmux switch-client -t "$SESSION_NAME"
        else
            exec tmux new-session -s "$SESSION_NAME" -c "$PROJECT_ROOT" "$LAUNCHER"
        fi
        ;;

    tmux)
        log_info "モード: tmux (後方互換)"
        echo ""

        SETUP_SCRIPT=$(yaml_value "$CONFIG_FILE" "tmux.setup_script")
        SETUP_SCRIPT="${SETUP_SCRIPT:-$MA_FRAMEWORK_DIR/scripts/setup.sh}"

        if [[ -f "$SETUP_SCRIPT" ]]; then
            log_info "setup.sh を実行: $SETUP_SCRIPT"
            exec "$SETUP_SCRIPT" "$@"
        else
            log_error "setup.sh が見つかりません: $SETUP_SCRIPT"
            exit 1
        fi
        ;;

    *)
        log_error "不明なモード: $MODE"
        log_error "config.yaml の mode を 'teams' または 'tmux' に設定してください。"
        exit 1
        ;;
esac
